#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Å—Ä–µ–¥—ã —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ –¥–ª—è iPay OpenCart –º–æ–¥—É–ª—è
set -e

# –¶–≤–µ—Ç–∞ –¥–ª—è –≤—ã–≤–æ–¥–∞
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

echo -e "${GREEN}üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å—Ä–µ–¥—ã —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ iPay OpenCart –º–æ–¥—É–ª—è${NC}"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –º—ã –Ω–∞—Ö–æ–¥–∏–º—Å—è –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
if [[ ! -f "README.md" ]] || [[ ! -d "upload" ]]; then
    echo -e "${RED}‚ùå –û—à–∏–±–∫–∞: –∑–∞–ø—É—Å—Ç–∏—Ç–µ —Å–∫—Ä–∏–ø—Ç –∏–∑ –∫–æ—Ä–Ω—è –ø—Ä–æ–µ–∫—Ç–∞${NC}"
    exit 1
fi

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Git hooks –∏ —à–∞–±–ª–æ–Ω–æ–≤
echo -e "${YELLOW}üìù –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Git...${NC}"

# –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º —à–∞–±–ª–æ–Ω –∫–æ–º–º–∏—Ç–æ–≤
if [[ -f ".gitmessage" ]]; then
    git config commit.template .gitmessage
    echo -e "${GREEN}‚úÖ –®–∞–±–ª–æ–Ω –∫–æ–º–º–∏—Ç–æ–≤ –Ω–∞—Å—Ç—Ä–æ–µ–Ω${NC}"
fi

# –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –∞–≤—Ç–æ—Ä –∫–æ–º–º–∏—Ç–æ–≤ –µ—Å–ª–∏ –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω
if ! git config user.name > /dev/null 2>&1; then
    echo -e "${YELLOW}‚öôÔ∏è  –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –≤–∞—à–µ –∏–º—è –¥–ª—è Git:${NC}"
    read -p "–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è: " git_name
    git config user.name "$git_name"
fi

if ! git config user.email > /dev/null 2>&1; then
    echo -e "${YELLOW}‚öôÔ∏è  –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –≤–∞—à email –¥–ª—è Git:${NC}"
    read -p "–í–≤–µ–¥–∏—Ç–µ –≤–∞—à email: " git_email
    git config user.email "$git_email"
fi

# –°–æ–∑–¥–∞–µ–º –ø–∞–ø–∫–∏ –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ –µ—Å–ª–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É—é—Ç
echo -e "${YELLOW}üìÅ –°–æ–∑–¥–∞–Ω–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π...${NC}"

mkdir -p {logs,temp,backup}

# –°–æ–∑–¥–∞–µ–º —Å–∏–º–≤–æ–ª–∏—á–µ—Å–∫–∏–µ —Å—Å—ã–ª–∫–∏ –¥–ª—è —É–¥–æ–±–Ω–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
echo -e "${YELLOW}üîó –•–æ—Ç–∏—Ç–µ —Å–æ–∑–¥–∞—Ç—å —Å–∏–º–≤–æ–ª–∏—á–µ—Å–∫–∏–µ —Å—Å—ã–ª–∫–∏ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è?${NC}"
read -p "–£–∫–∞–∂–∏—Ç–µ –ø—É—Ç—å –∫ –∫–æ—Ä–Ω—é OpenCart –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è (–∏–ª–∏ Enter –¥–ª—è –ø—Ä–æ–ø—É—Å–∫–∞): " opencart_path

if [[ -n "$opencart_path" ]] && [[ -d "$opencart_path" ]]; then
    echo -e "${BLUE}üîó –°–æ–∑–¥–∞–Ω–∏–µ —Å–∏–º–≤–æ–ª–∏—á–µ—Å–∫–∏—Ö —Å—Å—ã–ª–æ–∫...${NC}"
    
    # –°–æ–∑–¥–∞–µ–º —Å–∏–º–≤–æ–ª–∏—á–µ—Å–∫–∏–µ —Å—Å—ã–ª–∫–∏
    ln -sfn "$(pwd)/upload/admin" "$opencart_path/admin/controller/extension/payment/ipay_link"
    ln -sfn "$(pwd)/upload/catalog" "$opencart_path/catalog/controller/extension/payment/ipay_link"
    
    echo -e "${GREEN}‚úÖ –°–∏–º–≤–æ–ª–∏—á–µ—Å–∫–∏–µ —Å—Å—ã–ª–∫–∏ —Å–æ–∑–¥–∞–Ω—ã${NC}"
    echo -e "${YELLOW}‚ö†Ô∏è  –ù–µ –∑–∞–±—É–¥—å—Ç–µ —É–¥–∞–ª–∏—Ç—å –∏—Ö –ø–µ—Ä–µ–¥ –ø—Ä–æ–¥–∞–∫—à–Ω–æ–º!${NC}"
fi

# –°–æ–∑–¥–∞–µ–º —Ñ–∞–π–ª –¥–ª—è –ª–æ–∫–∞–ª—å–Ω—ã—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
if [[ ! -f ".env.local" ]]; then
    cat > ".env.local" << EOF
# –õ–æ–∫–∞–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
# –≠—Ç–æ—Ç —Ñ–∞–π–ª –Ω–µ –ø–æ–ø–∞–¥–∞–µ—Ç –≤ git

# –ü—É—Ç–∏ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
OPENCART_PATH="$opencart_path"

# –ù–∞—Å—Ç—Ä–æ–π–∫–∏ iPay –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
IPAY_TEST_MCH_ID="your_test_merchant_id"
IPAY_TEST_SIGN_KEY="your_test_signature_key"

# –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Ç–µ—Å—Ç–æ–≤ (–µ—Å–ª–∏ –Ω—É–∂–Ω—ã)
TEST_DB_HOST="localhost"
TEST_DB_NAME="opencart_test"
TEST_DB_USER="test_user"
TEST_DB_PASS="test_password"
EOF
    echo -e "${GREEN}‚úÖ –°–æ–∑–¥–∞–Ω —Ñ–∞–π–ª .env.local –¥–ª—è –ª–æ–∫–∞–ª—å–Ω—ã—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫${NC}"
fi

# –°–æ–∑–¥–∞–µ–º pre-commit hook –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ñ–æ—Ä–º–∞—Ç–∞ –∫–æ–º–º–∏—Ç–æ–≤
if [[ ! -f ".git/hooks/commit-msg" ]]; then
    cat > ".git/hooks/commit-msg" << 'EOF'
#!/bin/bash
# Pre-commit hook –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ñ–æ—Ä–º–∞—Ç–∞ –∫–æ–º–º–∏—Ç–æ–≤

commit_regex='^(feat|fix|docs|style|refactor|perf|test|chore)(\(.+\))?: .{1,50}'

if ! grep -qE "$commit_regex" "$1"; then
    echo "‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –∫–æ–º–º–∏—Ç–∞!"
    echo ""
    echo "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ñ–æ—Ä–º–∞—Ç: <type>: <description>"
    echo ""
    echo "–¢–∏–ø—ã:"
    echo "  feat:     –Ω–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å"
    echo "  fix:      –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–∞–≥–∞"
    echo "  docs:     –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏"
    echo "  style:    —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞"
    echo "  refactor: —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥"
    echo "  perf:     —É–ª—É—á—à–µ–Ω–∏–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏"
    echo "  test:     –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤"
    echo "  chore:    –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞"
    echo ""
    echo "–ü—Ä–∏–º–µ—Ä—ã:"
    echo "  feat: –¥–æ–±–∞–≤–ª–µ–Ω–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –Ω–æ–≤—ã—Ö –≤–∞–ª—é—Ç"
    echo "  fix: –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –æ—à–∏–±–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏"
    echo ""
    exit 1
fi
EOF
    chmod +x ".git/hooks/commit-msg"
    echo -e "${GREEN}‚úÖ –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω pre-commit hook –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫–æ–º–º–∏—Ç–æ–≤${NC}"
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤
echo -e "${YELLOW}üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏...${NC}"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º PHP
if command -v php > /dev/null 2>&1; then
    PHP_VERSION=$(php -v | head -n1 | cut -d' ' -f2 | cut -d'.' -f1,2)
    echo -e "${GREEN}‚úÖ PHP $PHP_VERSION —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω${NC}"
    
    if [[ $(echo "$PHP_VERSION >= 7.1" | bc -l) -eq 1 ]]; then
        echo -e "${GREEN}‚úÖ –í–µ—Ä—Å–∏—è PHP –ø–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è OpenCart 3.x${NC}"
    else
        echo -e "${YELLOW}‚ö†Ô∏è  –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è PHP 7.1+ –¥–ª—è OpenCart 3.x${NC}"
    fi
else
    echo -e "${YELLOW}‚ö†Ô∏è  PHP –Ω–µ –Ω–∞–π–¥–µ–Ω${NC}"
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º curl
if command -v curl > /dev/null 2>&1; then
    echo -e "${GREEN}‚úÖ curl —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω${NC}"
else
    echo -e "${YELLOW}‚ö†Ô∏è  curl –Ω–µ –Ω–∞–π–¥–µ–Ω (–Ω—É–∂–µ–Ω –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è API)${NC}"
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º git
if command -v git > /dev/null 2>&1; then
    echo -e "${GREEN}‚úÖ git —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω${NC}"
else
    echo -e "${RED}‚ùå git –Ω–µ –Ω–∞–π–¥–µ–Ω${NC}"
fi

# –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–ª–µ–¥—É—é—â–∏—Ö —à–∞–≥–∞—Ö
echo -e "${GREEN}üéâ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!${NC}"
echo ""
echo -e "${BLUE}üìã –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:${NC}"
echo "1. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ —Ñ–∞–π–ª—ã –∏–∑ upload/ –≤ –≤–∞—à —Ç–µ—Å—Ç–æ–≤—ã–π OpenCart"
echo "2. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –º–æ–¥—É–ª—å –≤ –∞–¥–º–∏–Ω–∫–µ OpenCart"
echo "3. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ iPay –≤ .env.local"
echo "4. –ù–∞—á–∏–Ω–∞–π—Ç–µ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫—É!"
echo ""
echo -e "${BLUE}üîß –ü–æ–ª–µ–∑–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:${NC}"
echo "  ./scripts/prepare-release.sh  - –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Ä–µ–ª–∏–∑–∞"
echo "  git log --oneline             - –ø—Ä–æ—Å–º–æ—Ç—Ä –∏—Å—Ç–æ—Ä–∏–∏ –∫–æ–º–º–∏—Ç–æ–≤"
echo "  git status                    - —Å—Ç–∞—Ç—É—Å –∏–∑–º–µ–Ω–µ–Ω–∏–π"
echo ""
echo -e "${BLUE}üìö –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è:${NC}"
echo "  README.md        - –æ—Å–Ω–æ–≤–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è"
echo "  CONTRIBUTING.md  - —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ"

# –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–µ–∫—É—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ git
echo ""
echo -e "${BLUE}‚öôÔ∏è  –¢–µ–∫—É—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ Git:${NC}"
echo "  –ò–º—è: $(git config user.name)"
echo "  Email: $(git config user.email)"
echo "  –®–∞–±–ª–æ–Ω –∫–æ–º–º–∏—Ç–æ–≤: $(git config commit.template || echo '–Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω')"